<!DOCTYPE html>
<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<style>
  #panes {   display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
  }

  </style>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>

<div id="modal" class="modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id ="modal-title">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>
</div>

<nav class="navbar fixed-top navbar-light bg-light">
  <div class="container-fluid">
    <h1 class="navbar-brand" href="#">The NotoVerse</h1>
    <select id="sort">
        <option value="cp">Sort by Codepoint</option>
        <option value="alpha">Sort Alphabetical</option>
      </select>
  </div>
</nav>

<div class="container pt-5">
<div id="panes">
</div>
</div>


<script>

  var loaded_blocks = {};

function doModal(block) {
  var myModal = new bootstrap.Modal(document.getElementById('modal'), {})
  $("#modal-title").html(block.name)
  appendFullBlock(block)
  myModal.handleUpdate()
  myModal.show()
}

function loadBlock() {
  var ix = $(this).data("block-id");
  padded = ix.toString().padStart(3,0)
  filename = `blocks/block-${padded}.json`;
  if (ix in loaded_blocks) {
    doModal(loaded_blocks[ix]);
  } else {
    $.getJSON(filename, function(block) {
      loaded_blocks[ix] = block;
      doModal(loaded_blocks[ix]);
    })
  }
}

function toHex(d) {
  return d.toString(16).toUpperCase().padStart(4, 0)
}

function appendSummaryBlock(ix, mydata) {
  width = 200
  height = 200

  var mydiv = $('<div class="pane card p-1">');
  $("#panes").append(mydiv);

  var title = $('<div class="title">');
  title.html(`<h5>${mydata.name}</h3>`);
  mydiv.append(title)

  var range = $('<div class="range">');
  range.html(`<small class="text-secondary">U+${toHex(mydata.start)}-U+${toHex(mydata.end)}</small>`);
  mydiv.append(range)

  var visualization = $('<div>');
  visualization.data("block-id", mydata.ix);
  visualization.click(loadBlock);
  mydiv.append(visualization)

  var svg = d3.select(visualization[0])
  .append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")

  var codepoints = mydata.end-mydata.start+1
  rows = parseInt(codepoints ** 0.5)
  cols = Math.ceil(codepoints/rows)
  rows_domain = [...Array(rows).keys()]
  cols_domain = [...Array(cols).keys()]
  var summary = mydata.summary.split("")
  data = []
  var index = 0;
  for (var thing of summary) {
    data.push({
      "row": parseInt(index / cols),
      "col": index % cols,
      "cp": index + mydata.start,
      "status": thing
    })
    index = index+1;
  }

  myColor = function(status) {
    if (status == "X") { return "silver" }
    if (status == "1") { return "olivedrab" }
    if (status == "M") { return "darkgreen" }
    if (status == "0") { return "crimson"}
  }
    // Build X scales and axis:
    x = d3.scaleBand()
      .range([ 0, width ])
      .domain(cols_domain)
      .padding(0.05);

    // Build Y scales and axis:
    y = d3.scaleBand()
      .range([ 0, height ])
      .domain(rows_domain)
      .padding(0.05);

    // add the squares
    svg.selectAll()
      .data(data, function(d) {return d.cp;})
      .enter()
      .append("rect")
        .attr("x", function(d) { return x(d.col) })
        .attr("y", function(d) { return y(d.row) })
        .attr("rx", 4)
        .attr("ry", 4)
        .attr("width", x.bandwidth() )
        .attr("height", y.bandwidth() )
        .style("fill", function(d) { return d3.color(myColor(d.status))} )
        .style("stroke-width", 4)
        .style("stroke", "none")
        .style("opacity", 0.8)
}


function appendFullBlock( mydata) {
  width = 500
  height = 500

  var visualization = $('#modal-body');
  $(visualization).empty();
  var svg = d3.select(visualization[0])
  .append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")

  var codepoints = mydata.end-mydata.start+1
  rows = parseInt(codepoints ** 0.5)
  cols = Math.ceil(codepoints/rows)
  rows_domain = [...Array(rows).keys()]
  cols_domain = [...Array(cols).keys()]
  data = []
  var index = 0;
  console.log(mydata);
  while (index < codepoints)  {
    var ix = mydata.start + index;
    var cp = mydata.cps[ix] || { unassigned: "true"};
    if ("fonts" in mydata) {
      fonts = mydata.fonts
    } else if ("fonts" in cp) {
      fonts = cp.fonts
    } else {
      fonts = ""
    }
    data.push({
      "row": parseInt(index / cols),
      "col": index % cols,
      "cp": index + mydata.start,
      "name": cp.name,
      "special": cp.special,
      "unassigned": cp.unassigned,
      "fonts": fonts,
      "value": cp,
      "age": mydata.age || cp.age
    })
    index = index+1;
  }
  console.log(data)

  myColor = function(el) {
    if (el.unassigned) { return "silver" }
    if (el.special) { return "black" }
    if (el.fonts.length == 1) { return "olivedrab" }
    if (el.fonts.length > 1) { return "darkgreen" }
    if (el.fonts.length == 0) { return "crimson"}
  }

// create a tooltip
  var tooltip = d3.select(visualization[0])
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    if (d.unassigned) { return; }
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    if (d.unassigned) { return; }
    tooltip
      .html(`
        <h1 class="center-text">${String.fromCodePoint(d.cp)}</h1>
        <dl class="row">
          <dd class="col-sm-3">Codepoint</dd> <dt class="col-sm-9">${toHex(d.cp)}</dt>
          <dd class="col-sm-3">Name</dd> <dt class="col-sm-9">${d.name}</dt>
          <dd class="col-sm-3">Age</dd>  <dt class="col-sm-9">${d.age}</dt>
          <dd class="col-sm-3">Fonts</dd>  <dt class="col-sm-9">${(d.fonts||[]).join(", ")}</dt>
        </dl>
      `)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    if (d.unassigned) { return; }
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
  }

    // Build X scales and axis:
    x = d3.scaleBand()
      .range([ 0, width ])
      .domain(cols_domain)
      .padding(0.05);

    // Build Y scales and axis:
    y = d3.scaleBand()
      .range([ 0, height ])
      .domain(rows_domain)
      .padding(0.05);

    // add the squares
    svg.selectAll()
      .data(data, function(d) {return d.cp;})
      .enter()
      .append("rect")
        .attr("x", function(d) { return x(d.col) })
        .attr("y", function(d) { return y(d.row) })
        .attr("rx", 4)
        .attr("ry", 4)
        .attr("width", x.bandwidth() )
        .attr("height", y.bandwidth() )
        .style("fill", function(d) { return d3.color(myColor(d))} )
        .style("stroke-width", 4)
        .style("stroke", "none")
        .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave)
}

function rebuildSummary() {
  $("#panes").empty();
  for (ix in window.summary) {appendSummaryBlock(ix, window.summary[ix])}
}

$(function() {
  $.getJSON("blocks.json", function(data) {
    window.summary = data
    rebuildSummary()
  })
  $("#sort").change(function() {
    if ($("#sort").val() == "alpha") {
      window.summary = window.summary.sort((a,b) => a.name.localeCompare(b.name));
    } else {
      window.summary = window.summary.sort((a,b) => a.ix - b.ix);
    }
    rebuildSummary()
  })
})
</script>
</body>
</html>
